<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Robot Ecol√≥gico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --verde: #16a34a;
        --naranja: #f97316;
        --gris-fondo: #f3f4f6;
      }

      body {
        background-color: var(--gris-fondo);
      }
    </style>
  </head>

  <body class="min-h-screen flex flex-col">
    <!-- HEADER -->
    <header class="bg-[color:var(--naranja)] text-white shadow-md">
      <div
        class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-2xl"
          >
            ‚ôªÔ∏è
          </div>
          <div>
            <h1 class="text-xl font-semibold">Robot Ecol√≥gico</h1>
            <p class="text-xs text-orange-100">
              Panel de monitoreo en tiempo real
            </p>
          </div>
        </div>

        <span id="last-update" class="text-xs text-orange-100">
          √öltima actualizaci√≥n: ‚Äî
        </span>
      </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
        <!-- FILA SUPERIOR: ESTADO + SENSORES -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- ESTADO DEL ROBOT -->
          <section
            class="md:col-span-1 bg-white rounded-xl shadow p-4 flex flex-col gap-3"
          >
            <h2 class="text-lg font-semibold flex items-center gap-2">
              <span class="text-2xl">ü§ñ</span>
              Estado del robot
            </h2>

            <div class="flex items-center gap-3">
              <div
                id="estado-pill"
                class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700"
              >
                DESCONOCIDO
              </div>
              <span id="estado-origen" class="text-xs text-gray-400">
                Origen: ‚Äî
              </span>
            </div>

            <p id="estado-mensaje" class="text-sm text-gray-600">
              Esperando datos...
            </p>

            <!-- Acciones simples -->
            <div class="mt-3">
              <p class="text-xs font-semibold text-gray-500 mb-1">
                Comandos r√°pidos:
              </p>
              <div class="flex flex-wrap gap-2">
                <button
                  class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 hover:bg-gray-300 transition"
                  onclick="enviarComando('PAUSAR')"
                >
                  ‚è∏Ô∏è Pausar
                </button>
                <button
                  class="px-3 py-1 rounded-full text-xs font-semibold bg-[color:var(--verde)] text-white hover:brightness-110 transition"
                  onclick="enviarComando('REANUDAR')"
                >
                  ‚ñ∂Ô∏è Reanudar
                </button>
                <button
                  class="px-3 py-1 rounded-full text-xs font-semibold bg-red-500 text-white hover:bg-red-600 transition"
                  onclick="enviarComando('ERROR')"
                >
                  ‚ö†Ô∏è Marcar error
                </button>
              </div>
              <p
                id="comando-respuesta"
                class="mt-2 text-[11px] text-gray-500"
              ></p>
            </div>
          </section>

          <!-- SENSORES -->
          <section
            class="md:col-span-2 bg-white rounded-xl shadow p-4 flex flex-col gap-3"
          >
            <h2 class="text-lg font-semibold flex items-center gap-2">
              <span class="text-2xl">üì°</span>
              Sensores
            </h2>

            <p
              id="sensores-fecha"
              class="text-xs text-gray-400 mb-1"
            >
              Sin telemetr√≠a recibida.
            </p>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <!-- Distancia -->
              <div
                class="bg-gray-50 rounded-lg p-3 flex flex-col items-center"
              >
                <span class="text-xs text-gray-500">Distancia</span>
                <span
                  id="sensor-distancia"
                  class="text-lg font-semibold text-gray-800"
                  >‚Äî</span
                >
                <span class="text-[11px] text-gray-400">cm</span>
              </div>

              <!-- Nivel basura -->
              <div
                class="bg-gray-50 rounded-lg p-3 flex flex-col items-center"
              >
                <span class="text-xs text-gray-500">Nivel de basura</span>
                <span
                  id="sensor-nivel"
                  class="text-lg font-semibold text-gray-800"
                  >‚Äî</span
                >
                <span class="text-[11px] text-gray-400">% aprox.</span>
              </div>

              <!-- Peso -->
              <div
                class="bg-gray-50 rounded-lg p-3 flex flex-col items-center"
              >
                <span class="text-xs text-gray-500">Peso</span>
                <span
                  id="sensor-peso"
                  class="text-lg font-semibold text-gray-800"
                  >‚Äî</span
                >
                <span class="text-[11px] text-gray-400">kg</span>
              </div>

              <!-- Temperatura -->
              <div
                class="bg-gray-50 rounded-lg p-3 flex flex-col items-center"
              >
                <span class="text-xs text-gray-500">Temperatura</span>
                <span
                  id="sensor-temp"
                  class="text-lg font-semibold text-gray-800"
                  >‚Äî</span
                >
                <span class="text-[11px] text-gray-400">¬∞C</span>
              </div>
            </div>

            <!-- Tapa -->
            <div class="mt-2 flex items-center gap-2 text-sm">
              <span class="text-xs text-gray-500">Estado tapa:</span>
              <span
                id="sensor-tapa"
                class="px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-700"
                >‚Äî</span
              >
            </div>
          </section>
        </div>

        <!-- TABLA DE EVENTOS -->
        <section class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold flex items-center gap-2">
              <span class="text-2xl">üìã</span>
              Eventos recientes
            </h2>
            <button
              class="text-xs px-3 py-1 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-100 transition"
              onclick="cargarEventos()"
            >
              üîÑ Actualizar
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-left text-sm">
              <thead>
                <tr class="border-b text-xs text-gray-500">
                  <th class="py-2 pr-2">Fecha/Hora</th>
                  <th class="py-2 pr-2">Tipo</th>
                  <th class="py-2 pr-2">Acci√≥n</th>
                  <th class="py-2 pr-2">Detalle</th>
                  <th class="py-2 pr-2">Confianza</th>
                </tr>
              </thead>
              <tbody id="tabla-eventos" class="text-xs text-gray-700">
                <tr>
                  <td colspan="5" class="py-3 text-center text-gray-400">
                    Sin eventos a√∫n
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="text-center text-[11px] text-gray-400 py-3">
      Robot Ecol√≥gico ¬∑ Panel b√°sico ¬∑ Campo educativo ü§ñ‚ôªÔ∏è
    </footer>

    <!-- SCRIPT: Conexi√≥n con el backend -->
    <script>
      const API_BASE = "http://localhost:5000/api";

      function formatearFecha(isoStr) {
        if (!isoStr) return "‚Äî";
        const d = new Date(isoStr);
        return d.toLocaleString();
      }

      // Cambiar color del pill de estado seg√∫n texto
      function pintarEstado(estado) {
        const pill = document.getElementById("estado-pill");
        const upper = (estado || "DESCONOCIDO").toUpperCase();
        pill.textContent = upper;
        pill.className =
          "px-3 py-1 rounded-full text-xs font-semibold transition";

        if (upper === "ONLINE" || upper === "REANUDAR") {
          pill.classList.add("bg-green-100", "text-green-700");
        } else if (upper === "OFFLINE") {
          pill.classList.add("bg-gray-200", "text-gray-700");
        } else if (upper === "PAUSAR" || upper === "PAUSADO") {
          pill.classList.add("bg-yellow-100", "text-yellow-700");
        } else if (upper === "ERROR" || upper === "LLENO") {
          pill.classList.add("bg-red-100", "text-red-700");
        } else {
          pill.classList.add("bg-gray-200", "text-gray-700");
        }
      }

      async function cargarEstado() {
        try {
          const resp = await fetch(`${API_BASE}/estado`);
          const data = await resp.json();

          document.getElementById("estado-origen").textContent =
            "Origen: " + (data.origen || "‚Äî");
          document.getElementById("estado-mensaje").textContent =
            data.mensaje || "‚Äî";
          pintarEstado(data.estado);

          document.getElementById("last-update").textContent =
            "√öltima actualizaci√≥n: " + new Date().toLocaleTimeString();
        } catch (err) {
          console.error("Error cargando estado:", err);
          document.getElementById("estado-mensaje").textContent =
            "Error al obtener estado del servidor.";
          pintarEstado("ERROR");
        }
      }

      async function cargarTelemetria() {
        try {
          const resp = await fetch(`${API_BASE}/telemetria/ultima`);
          if (!resp.ok) {
            document.getElementById("sensores-fecha").textContent =
              "Sin telemetr√≠a a√∫n.";
            return;
          }

          const data = await resp.json();
          const sensores = data.sensores || {};

          document.getElementById("sensores-fecha").textContent =
            "√öltima telemetr√≠a: " + formatearFecha(data.fecha);

          document.getElementById("sensor-distancia").textContent =
            sensores.distancia_cm ?? "‚Äî";
          document.getElementById("sensor-nivel").textContent =
            sensores.nivel_basura ?? "‚Äî";
          document.getElementById("sensor-peso").textContent =
            sensores.peso_kg ?? "‚Äî";
          document.getElementById("sensor-temp").textContent =
            sensores.temperatura_c ?? "‚Äî";

          const tapaText =
            sensores.tapa_abierta === true
              ? "Abierta"
              : sensores.tapa_abierta === false
              ? "Cerrada"
              : "‚Äî";
          document.getElementById("sensor-tapa").textContent = tapaText;
        } catch (err) {
          console.error("Error cargando telemetr√≠a:", err);
          document.getElementById("sensores-fecha").textContent =
            "Error al obtener telemetr√≠a.";
        }
      }

      async function cargarEventos() {
        try {
          const resp = await fetch(`${API_BASE}/eventos`);
          const data = await resp.json();
          const tbody = document.getElementById("tabla-eventos");

          if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="py-3 text-center text-gray-400">Sin eventos a√∫n</td></tr>';
            return;
          }

          tbody.innerHTML = "";
          data
            .slice()
            .reverse()
            .forEach((ev) => {
              const tr = document.createElement("tr");
              tr.className = "border-b last:border-0";

              tr.innerHTML = `
              <td class="py-2 pr-2">${formatearFecha(ev.fecha)}</td>
              <td class="py-2 pr-2">${ev.tipo || "‚Äî"}</td>
              <td class="py-2 pr-2">${ev.accion || "‚Äî"}</td>
              <td class="py-2 pr-2">${ev.detalle || "‚Äî"}</td>
              <td class="py-2 pr-2">${ev.nivel_confianza ?? "‚Äî"}</td>
            `;

              tbody.appendChild(tr);
            });
        } catch (err) {
          console.error("Error cargando eventos:", err);
        }
      }

      async function enviarComando(comando) {
        try {
          const resp = await fetch(`${API_BASE}/comandos`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ comando }),
          });

          const data = await resp.json();
          document.getElementById("comando-respuesta").textContent =
            "Respuesta: " + (data.message || "Comando enviado.");

          // Actualizar estado despu√©s de enviar comando
          cargarEstado();
        } catch (err) {
          console.error("Error enviando comando:", err);
          document.getElementById("comando-respuesta").textContent =
            "Error al enviar comando.";
        }
      }

      // Cargar al inicio
      cargarEstado();
      cargarTelemetria();
      cargarEventos();

      // Actualizar cada 3 segundos
      setInterval(() => {
        cargarEstado();
        cargarTelemetria();
      }, 3000);
    </script>
  </body>
</html>
